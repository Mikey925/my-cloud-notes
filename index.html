<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯ç­†è¨˜ (MyNotes)</title>
    <style>
        /* --- æš—å¤œæ¨¡å¼æ¨£å¼ (Dark Mode) --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #121212; 
            color: #e0e0e0; 
        }
        
        h1 {
            color: #bb86fc; 
            font-weight: normal;
            font-size: 1.8rem;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        textarea { 
            width: 100%; 
            height: 60vh; /* ä½”æ“šè¢å¹•é«˜åº¦çš„ 60% */
            padding: 15px; 
            font-size: 16px; 
            line-height: 1.6;
            border: 1px solid #333; 
            border-radius: 8px; 
            resize: vertical; 
            background-color: #1e1e1e; 
            color: #ffffff; 
            outline: none;
            box-sizing: border-box; 
        }

        textarea:focus {
            border-color: #bb86fc; 
        }

        /* æŒ‰éˆ•å€åŸŸ */
        .btn-group {
            margin-top: 15px;
            display: flex;
            gap: 10px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }

        button { 
            padding: 12px 24px; 
            font-size: 16px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            transition: opacity 0.2s;
        }
        
        button:hover { opacity: 0.8; }

        /* å„²å­˜æŒ‰éˆ• (é’è‰²) */
        #saveBtn {
            background-color: #03dac6; 
            color: #000000; 
        }

        /* å‚™ä»½æŒ‰éˆ• (ç´«è‰²) */
        #backupBtn {
            background-color: #bb86fc;
            color: #000000;
        }
        
        /* ç‹€æ…‹æ–‡å­— */
        #statusMsg { 
            margin-left: 15px; 
            color: #888; 
            font-size: 14px; 
            align-self: center;
        }
    </style>
</head>
<body>
    <h1>æˆ‘çš„åŒæ­¥ç­†è¨˜æœ¬</h1>
    
    <!-- ç­†è¨˜è¼¸å…¥å€ -->
    <textarea id="noteArea" placeholder="æ­£åœ¨é€£ç·šåˆ°å¤§è…¦è³‡æ–™åº«..."></textarea>
    
    <!-- æŒ‰éˆ•å€ -->
    <div class="btn-group">
        <button id="saveBtn">â˜ï¸ å„²å­˜åˆ°é›²ç«¯</button>
        <button id="backupBtn">ğŸ’¾ ä¸‹è¼‰å‚™ä»½åˆ°é›»è…¦</button>
        <span id="statusMsg">æº–å‚™å°±ç·’</span>
    </div>

    <!-- JavaScript é‚è¼¯å€ -->
    <script type="module">
        // å¼•å…¥ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // -------------------------------------------------------
        // ä½ çš„å°ˆå±¬é‡‘é‘° (å·²å¡«å…¥)
        // -------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyCeBsVFXuZ7eVP_Sq3d34Fko_Dmb0LJ7rg",
            authDomain: "my-cloud-save-place.firebaseapp.com",
            projectId: "my-cloud-save-place",
            storageBucket: "my-cloud-save-place.firebasestorage.app",
            messagingSenderId: "91753582046",
            appId: "1:91753582046:web:3a46d3ce864c8f05d6214f"
        };
        // -------------------------------------------------------

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // è¨­å®šç­†è¨˜å­˜å–ä½ç½®
        const noteDocRef = doc(db, "notes", "my_note"); // Collection: notes, Doc: my_note
        
        const noteArea = document.getElementById('noteArea');
        const saveBtn = document.getElementById('saveBtn');
        const backupBtn = document.getElementById('backupBtn');
        const statusMsg = document.getElementById('statusMsg');

        // 1. [è®€å–åŒæ­¥] ç›£è½é›²ç«¯è®ŠåŒ–
        onSnapshot(noteDocRef, (doc) => {
            if (doc.exists()) {
                // å¦‚æœä½¿ç”¨è€…æ­£åœ¨æ‰“å­— (ç„¦é»åœ¨è¼¸å…¥æ¡†)ï¼Œä¸è¦å¼·åˆ¶è¦†è“‹ï¼Œé¿å…æ‰“æ–·æ€è·¯
                // åªæœ‰ç•¶ç„¦é»ä¸åœ¨è¼¸å…¥æ¡†æ™‚ï¼Œæ‰è‡ªå‹•æ›´æ–°
                if (document.activeElement !== noteArea) {
                    noteArea.value = doc.data().content || "";
                    statusMsg.textContent = "å·²åŒæ­¥æœ€æ–°é›²ç«¯å…§å®¹";
                    setTimeout(() => statusMsg.textContent = "å°±ç·’", 3000);
                }
            } else {
                statusMsg.textContent = "é›²ç«¯å°šç„¡è³‡æ–™ï¼Œè«‹é–‹å§‹å¯«ä½œ";
            }
        }, (error) => {
            console.error("åŒæ­¥éŒ¯èª¤:", error);
            statusMsg.textContent = "é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
        });

        // 2. [å¯«å…¥é›²ç«¯] é»æ“Šå„²å­˜
        saveBtn.addEventListener('click', async () => {
            try {
                statusMsg.textContent = "æ­£åœ¨ä¸Šå‚³...";
                await setDoc(noteDocRef, {
                    content: noteArea.value,
                    updatedAt: new Date() // ç´€éŒ„æ›´æ–°æ™‚é–“
                });
                statusMsg.textContent = "âœ… é›²ç«¯å„²å­˜æˆåŠŸï¼";
                statusMsg.style.color = "#03dac6";
                setTimeout(() => {
                    statusMsg.textContent = "å°±ç·’";
                    statusMsg.style.color = "#888";
                }, 3000);
            } catch (e) {
                console.error("Error:", e);
                statusMsg.textContent = "âŒ å„²å­˜å¤±æ•—";
                statusMsg.style.color = "#cf6679";
            }
        });

        // 3. [æœ¬åœ°å‚™ä»½] ä¸‹è¼‰ç‚º .txt
        backupBtn.addEventListener('click', () => {
            const textToSave = noteArea.value;
            if (!textToSave) {
                statusMsg.textContent = "æ²’æœ‰å…§å®¹å¯å‚™ä»½";
                return;
            }

            // ç”¢ç”Ÿæª”åï¼šNote_Backup_2023-11-21.txt
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0]; 
            const fileName = `Note_Backup_${dateStr}.txt`;

            const blob = new Blob([textToSave], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            statusMsg.textContent = "âœ… å·²ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ";
        });
    </script>
</body>
</html>